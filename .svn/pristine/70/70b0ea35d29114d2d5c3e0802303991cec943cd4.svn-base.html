<html>
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />

		<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="../js/jquery-ui.js"></script>
		<script type="text/javascript" src="../js/purl.js"></script>
		<script type="text/javascript" src="../js/css_browser_selector.js"></script>

		<link rel="stylesheet" type="text/css" href="../css/jquery-ui-1.10.4.css" />


<style type="text/css">

body {	background: #ccc;	}


#divRole {
	text-align: left;
	font-size: 0.9em;
}
.datosUsuario{	position: absolute;	}


button {	width: 100px;	}
.ui-widget {	font-size: 0.8em;	}


label {
	width: 120px;
	display: inline-block;
	font-size: 9pt;
}

.cajadetexto {
	width: 200px;
	background-color: #fff;
	border: double #aaa 0.25em;
	border-radius: 5px;
	text-align: center	!important;
}
.cajadetexto:focus {	border: double #888 0.25em;	}

.chrome br.plus {	display: none;	}
.chrome br {	line-height: 1em;	}

</style>

<script type="text/javascript">

var login = null;
var Fname = null;
var Lname = null;
var dialog;

$(document).ready(function() {
	
	login = $.url().param('login');
	Fname = $.url().param('Fname');
	Lname = $.url().param('Lname');
	dialog = window.parent.$("#dynamicModalDialog");
	
	dialog.dialog( 'option', 'title', 'ASIGNAR ROL A USUARIO' );
	
	dialog.bind('dialogbeforeclose', function(event, ui) {
		  alert('Debe completar las asignaciones\npara terminar de crear el usuario,\n'+
				 'de lo contrario presione el botón CANCELAR');
		  return false;
	});
	
	$('#spnData').text(login + ' ( ' + Fname + ' ' +  Lname +  ' )');
	
	
	
	$.getJSON("../restricted/rest/abm/allroles")
	.done(function(data) {
		
	if(data && data.length > 0){
			
		var roleSelect = $('#cmbRole');
		roleSelect.find('option').remove().end();
		roleSelect.append('<option value="" ></option>');
		
		$.each(data, function(i , rol) {
			roleSelect.append('<option  id="rol_'+rol.id+'" value="' + rol.name + '">' + rol.name + '</option>');
		});
		
	}}).fail(function(){alert('ERROR al cargar los roles');});
	
	
	
	$('#btnRole').button({ icons: { primary: 'ui-icon-circle-check' } })
					.on('click' , function() { assignRole(); });
	$('#btnCancelar').button({ icons: { primary: 'ui-icon-circle-close' } })
					.on('click' , function() { if(confirm('Si no confirma las asignaciones,\n'+
															'el nuevo usuario "'+login+'" se borrará')) deleteUser(); });
	
	var margen = ( $('body').width() - 166 ) / 2 ;
	
	$('#divRole').css( 'padding-left' , margen+'px');
	
	$('#cmbRole').on('change', function(){$('#lblData').hide();
										  $('form[name=dataUser]').children().remove();
										  addForm();});
	
	$('#lblData').hide();
});

function assignRole() {
	
	if( $('#cmbRole').val() == '' ) alert( 'seleccione un rol para el usuario' );
	
	else{

		var Rname = $('#cmbRole').val();
		var form = $('form[name="dataUser"]');
		
			
			if(isClear()){
				alert('Hay campos obligatorios sin completar');
				return;
			}
			if(Rname.startsWith('Medico') && $('#user_ab_name').val().length > 4){
				alert('El nombre no debe tener más de 4 caracteres');
				return;
			}
			
			$.post('../restricted/rest/medicos/new/' + login + '/' + Rname, form.serialize())
				.done(function(){
				var url = '../ABM/AsignarInstitucion.html?login=' + login + '&Fname=' + Fname + '&Lname=' + Lname 
									+ '&Rname=' + Rname + '&new=true';
		
				window.parent.$("#dynamicModalDialogIframe").attr('src' , url);	
				
			})
			.fail(function(){alert('ocurrió un error con los datos de usuario');});
		
		
	}
}

function deleteUser(){
	
	$.post('../restricted/rest/abm/deleteUser', 'login='+login);
	dialog.unbind('dialogbeforeclose');
	window.parent.$('#dynamicModalDialogIframe').attr('src', 'about:blank');
	dialog.dialog('close');
}

function addForm(){
	
	var form = $('form[name="dataUser"]'),
	select = $('#cmbRole');
	
	$('#lblData').show();
	
	var medico = 
	'<label class="txtlabel">Mail: <b>(*)</b></label>'	+
	'<input type="text" id="user_mail" name="mail" class="cajadetexto" />'	+
	'<br><br>'	+
	'<label class="txtlabel">N&uacute;mero Tel&eacute;fono: <b>(*)</b></label>'	+
	'<input type="text" id="user_phone1" name="phone1" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
	'<br><br>'	+
	'<label class="txtlabel">Otro N&uacute;mero:</label>'	+
	'<input type="text" id="user_phone2" name="phone2" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
	'<br><br>'	+
	'<label class="txtlabel">Contacto Skype:</label>'	+
	'<input type="text" id="user_skype" name="skype" class="cajadetexto" />'	+
	'<br><br>'	+
	'<label class="txtlabel">Nombre Abreviado: <b>(*)</b></label>'	+
	'<input type="text" id="user_ab_name" name="ab_name" class="cajadetexto" placeholder="hasta 4 caracteres" />'	+
	'<br><br>'	+
	'<label class="txtlabel">T&iacute;tulo:</label>'	+
	'<input type="text" id="user_title" name="title" class="cajadetexto" />'	+
	'<br><br>'	+
	'<label class="txtlabel">Matr&iacute;cula:</label>'	+
	'<input type="text" id="user_matr" name="matr" class="cajadetexto" />'	+
	
	'<br>'	+
	'<h5 align="center">(*) campo obligatorio</h5>'	+
	'<br>',
	
	admin = 
		'<label class="txtlabel">Mail: <b>(*)</b></label>'	+
		'<input type="text" id="user_mail" name="mail" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">N&uacute;mero Tel&eacute;fono: <b>(*)</b></label>'	+
		'<input type="text" id="user_phone1" name="phone1" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Otro N&uacute;mero:</label>'	+
		'<input type="text" id="user_phone2" name="phone2" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Contacto Skype:</label>'	+
		'<input type="text" id="user_skype" name="skype" class="cajadetexto" />'	+
		
		'<br>'	+
		'<h5 align="center">(*) campo obligatorio</h5>'	+
		'<br>',
		
	centro = 
		'<label class="txtlabel">Mail: <b>(*)</b></label>'	+
		'<input type="text" id="user_mail" name="mail" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Direcci&oacute;n:</label>'	+
		'<input type="text" id="user_address" name="address" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Localidad:</label>'	+
		'<input type="text" id="user_loc" name="localidad" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Provincia:</label>'	+
		'<input type="text" id="user_prov" name="provincia" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">N&uacute;mero Tel&eacute;fono: <b>(*)</b></label>'	+
		'<input type="text" id="user_phone1" name="phone1" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Otro N&uacute;mero:</label>'	+
		'<input type="text" id="user_phone2" name="phone2" class="cajadetexto" placeholder="celular, fijo, etc" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Contacto Skype:</label>'	+
		'<input type="text" id="user_skype" name="skype" class="cajadetexto" />'	+
		'<br><br>'	+
		'<label class="txtlabel">Nombre Común:</label>'	+
		'<input type="text" id="user_f_name" name="f_name" class="cajadetexto" placeholder="cómo se nombra usualmente" />'	+
		
		'<br>'	+
		'<h5 align="center">(*) campo obligatorio</h5>'	+
		'<br>';
		
		
	if(select.val().startsWith('Medico')) {
		
		form.append(medico);
		$('.datosUsuario').css('padding-left', (($('body').width() - $('.datosUsuario').width()) / 2) + 'px' );
		$('.divButtons').css('padding-top', ($('.datosUsuario').height() - 30) + 'px');
	
	}
	else if(select.val().startsWith('Admin')){
		
		form.append(admin);
		$('.datosUsuario').css('padding-left', (($('body').width() - $('.datosUsuario').width()) / 2) + 'px' );
		$('.divButtons').css('padding-top', ($('.datosUsuario').height() - 30) + 'px');
	}
	else if(select.val().startsWith('Centro')){
		
		form.append(centro);
		$('.datosUsuario').css('padding-left', (($('body').width() - $('.datosUsuario').width()) / 2) + 'px' );
		$('.divButtons').css('padding-top', ($('.datosUsuario').height() - 30) + 'px');
	}
	else{
		$('.divButtons').css('padding-top', '0px');
	}
	
}

function isClear(){
	
	return $('#user_mail').val() == ''
		|| $('#user_phone1').val() == ''
		|| $('#user_ab_name').val() == '';
}

</script>


</head>

<body>

<span style="font-weight: bold; font-size:0.9em">Usuario: </span><span id="spnData" style="font-size: 0.85em;"></span>

<br><br>

<span style="font-weight: bold; font-size: 0.8em;">Seleccione el rol que tendrá el usuario.</span>

<br><br class="plus">

<div id="divRole">

	<select id="cmbRole"></select>

</div>

<br><br class="plus">

<span id="lblData" style="font-weight: bold; font-size: 0.8em;">Datos complementarios del usuario.</span>

<br><br class="plus"><br><br class="plus">

<div class="datosUsuario">
	
	<form name="dataUser" autocomplete="off"></form>

</div>

<br><br class="plus">

<div align="center" class="divButtons">
<button id="btnRole">Confirmar</button>
&nbsp;&nbsp;
<button id="btnCancelar">Cancelar</button>
</div>

</body>

</html>