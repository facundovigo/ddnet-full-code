<!DOCTYPE html>
<html>
	<head>
		<title>Observaciones</title>
		
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		
		<link rel="stylesheet" type="text/css" href="../css/jquery-ui-1.10.4.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout-default.css" />		
		<link rel="stylesheet" type="text/css" href="../css/main.css" />
		<link rel="stylesheet" type="text/css" href="../css/study-notes.css" />
		
		<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="../js/jquery-ui-1.10.4.js"></script>
		<script type="text/javascript" src="../js/jquery.layout-1.3.0.js"></script>
		<script type="text/javascript" src="../js/jquery.validate.js"></script>
		<script type="text/javascript" src="../js/jquery.blockUI.js"></script>		
		<script type="text/javascript" src="../js/purl.js"></script>
		
		<script type="text/javascript">
			var mainLayout = null;
			var studyID = null;
			var editMode = false;
			
			$(document).ready(function() {
				studyID = $.url().param('s');
				document.title += ' - Estudio: ' + studyID;
				editMode = $.url().param('e') == '1';
						
				mainLayout = $('body').layout({
					north__paneSelector:	".study-notes-layout-north",
					south__paneSelector:	".study-notes-layout-south",
					center__paneSelector:	".study-notes-layout-center",
										
					north__closable : false,
					north__resizable : false,
					north__spacing_open : 0,
					north__spacing_closed : 0
		
					,
					south__closable : false,
					south__resizable : false,
					south__spacing_open : 0,
					south__spacing_closed : 0
					
					,
					center__closable : false,
					center__resizable : false,
					center__spacing_open : 0,
					center__spacing_closed : 0
				});
								
				if (editMode) {
					$('#study-notes-body-editor').prop("readonly", null);
					
					
					$('#study-notes-save').button
					({
					    icons: { primary: "ui-icon-disk" }, text: true
					});
					
					$('#study-notes-save').click(function() {
						if (!studyID)
							return;
											
						var form = $('form[name="study-notes"]');
						
						$.post("rest/studies/" + studyID + "/notes", form.serialize())
						  .done(function(info) {
							  if (window.parent && window.parent.updateStudyData)
								  window.parent.updateStudyData(studyID);						  
						  })
						  .fail(function() {
						    alert('Ocurrió un error en la comunicación con el servidor. ' + 
						    	'Por favor, reintente la operación realizada.');
						  });
					});
				} else {
					$('#study-notes-save').hide();
				}

				$('#study-notes-exit').button
				({
				    icons: { primary: "ui-icon-close" }, text: true
				});				
				$('#study-notes-exit').click(function() {
					if (window.parent.closeModalDialog)
						window.parent.closeModalDialog();					
				});				
				
				getCurrentData();				
			});
						
			function getCurrentData() {
				$('#study-notes-body-editor').val('');
				$.get("rest/studies/" + studyID + '/notes')
				  .done(function(info) {
					  $('#study-notes-body-editor').val(info);
				  })
				  .fail(function() {
				    alert('Ocurrió un error en la comunicación con el servidor. ' + 
				    	'Por favor, reintente la operación realizada.');
					  if (window.parent.closeModalDialog)
						  window.parent.closeModalDialog();
				  });
			}
		</script>
	</head>
	<body>
		<div class="study-notes-layout-north">
		</div>
		<form id="study-notes" name="study-notes" method="post">
			<div class="study-notes-layout-center">
				<textarea id="study-notes-body-editor" name="notes" readonly="readonly">
				</textarea>
			</div>
		</form>
		<div class="study-notes-layout-south">
			<button type="button" id="study-notes-save" class="study-notes-action-button">
				Guardar cambios</button>
			<button type="button" id="study-notes-exit" class="study-notes-action-button">
				Salir</button>
		</div>		
	</body>
</html>
	