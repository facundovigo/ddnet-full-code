<!DOCTYPE html>
<html>
	<head>
		<title>Diagn&oacute;stico Digital - DDWEB - Administrador de estudios</title>
		
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		
		<link rel="stylesheet" type="text/css" href="../css/jquery-ui-1.10.4.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout-default.css" />		
		<link rel="stylesheet" type="text/css" href="../css/main.css" />
		<link rel="stylesheet" type="text/css" href="../css/study-manager.css" />
		<link rel="stylesheet" type="text/css" href="../css/jquery.dataTables.css" />
		<link rel="stylesheet" type="text/css" href="../css/dataTables.tableTools.css" />		
		<link rel="stylesheet" type="text/css" href="../css/dataTables.colVis.css" />
		
		<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="../js/jquery-ui-1.10.4.js"></script>
		<script type="text/javascript" src="../js/jquery.layout-1.3.0.js"></script>
		<script type="text/javascript" src="../js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../js/dataTables.tableTools.js"></script>		
		<script type="text/javascript" src="../js/TableTools.ShowSelectedOnly.js"></script>	
		<script type="text/javascript" src="../js/dataTables.colVis.js"></script>
		<script type="text/javascript" src="../js/jquery.validate.js"></script>
		<script type="text/javascript" src="../js/jquery.blockUI.js"></script>
		<script type="text/javascript" src="../js/jquery.ui-contextmenu.js"></script>
		<script type="text/javascript" src="../js/jquery.fileDownload.js"></script>		
		<script type="text/javascript" src="../js/jquery.ui.dialog-clickoutside.js"></script>
		<script type="text/javascript" src="../js/ddweb.js"></script>
		<script type="text/javascript" src="../js/datetime-moment.js"></script>
		<script type="text/javascript" src="../js/moment.min.js"></script>
		<script type="text/javascript">
			var mainLayout = null;
			var ddConfig = null;
			var userinfo = null;
								
			$(document).ready(function() {			
				// Operaciones al momento de realizar/analizar resultados de consultas AJAX. 
				$(document).on({
				     ajaxStart: function() { doBlockUI(); },
				     ajaxStop:  function() { doUnblockUI(); },    
				     ajaxError: function() { doUnblockUI(); },
				     ajaxComplete: function(event, jqXHR, ajaxOptions) 
				     {
				    	 var contentType = jqXHR.getResponseHeader("Content-Type");
				    	 if (!contentType || !contentType.match("^application/json"))
				    	 	window.location.href = '../authentication-servlet/logout'; 
				   	 }
				});
				
				readUserInfo();			
				
				// Obtener los valores de configuración
			    $.getJSON('rest/config/all')
					  .done(function(result) {
						  	ddConfig = result;
					  })
					  .fail(function() {
						  window.location.href = '../authentication-servlet/logout';
					  });				    
				
				mainLayout = $('body').layout({
					north__closable : false,
					north__resizable : false,
					north__spacing_open : 0,
					north__spacing_closed : 0,
					north__maxSize: 40,

					north__childOptions: {
						west__paneSelector:		".top-of-page-layout-west",
						center__paneSelector:	".top-of-page-layout-center",
						east__paneSelector:		".top-of-page-layout-east",
						
						west__closable : false,
						west__resizable : false,
						west__spacing_open : 0,
						west__spacing_closed : 0,
						west__minSize: 355,

						center__closable : false,
						center__resizable : false,
						center__spacing_open : 0,
						center__spacing_closed : 0,

						east__closable : false,
						east__resizable : false,
						east__spacing_open : 0,
						east__spacing_closed : 0,
						east__minSize: 400
					}
		
					,
					south__closable : false,
					south__resizable : false,
					south__spacing_open : 0,
					south__spacing_closed : 0
		
					,
					west__closable : true,
					west__resizable : true,
					west__spacing_open : 5,
					west__spacing_closed : 10,
					west__size : 355
					
					// Filters' layout
					,	
					west__childOptions: {
						north__paneSelector:	".study-layout-north",
						south__paneSelector:	".study-layout-south",
						center__paneSelector:	".study-layout-center",
						
						north__closable : false,
						north__resizable : false,
						north__spacing_open : 0,
						north__spacing_closed : 0,

						south__closable : false,
						south__resizable : false,
						south__spacing_open : 0,
						south__spacing_closed : 0,
						south__minSize: 32,		
												
						center__closable : false,
						center__resizable : false,
						center__spacing_open : 0,
						center__spacing_closed : 0						
					}					
				});
				
				// Botones del cuadro de búsqueda de estudios.
				$('#study-search-dosearch').button
					({
						icons: { primary: "ui-icon-search" }, text: true
					});
				$('#study-search-clean').button
					({
					    icons: { primary: "ui-icon-refresh" }, text: true
					});
				$('#study-search-close').button
					({
					    icons: { primary: "ui-icon-close" }, text: true
					});
				
				// Botones de acción sobre los estudios encontrados.
				$('#study-simple-view').button
				({
				    icons: { primary: "ui-icon-zoomout" }, text: true
				});
				$('#study-advanced-view').button
				({
				    icons: { primary: "ui-icon-zoomin" }, text: true
				});
				$('#study-view-report').button
				({
				    icons: { primary: "ui-icon-note" }, text: true
				});
				$('#study-edit-report').button
				({
				    icons: { primary: "ui-icon-pencil" }, text: true
				});				
				$('#study-files').button
				({
				    icons: { primary: "ui-icon-disk" }, text: true
				});				
				$('#study-dicomdir').button
				({
				    icons: { primary: "ui-icon-folder-collapsed" }, text: true
				});
				$('#study-notes').button
				({
				    icons: { primary: "ui-icon-pin-w" }, text: true
				});								
				
				// Configuración de los calendarios para búsqueda de estudios.				
				var dayNames = ["Domingo", "Lunes", "Martes", "Mi&eacute;rcoles", 
					"Jueves", "Viernes", "S&aacute;bado"]; 
				var dayNamesMin = ["DOM", "LUN", "MAR", "MIE", "JUE", "VIE", "SAB"];
				var monthNames = ["Enero", "Febrero", "Marzo", "Abril", 
				                  "Mayo", "Junio", "Julio", "Agosto",
				                  "Setiembre", "Octubre", "Noviembre", "Diciembre"];
				$("#study-date-between-from").datepicker({ dateFormat: "dd/mm/yy", 
					changeYear: true, yearRange: "-100:+0", changeMonth: true,
					dayNames: dayNames, dayNamesMin: dayNamesMin, monthNames: monthNames });
				$("#study-date-between-to").datepicker({ dateFormat: "dd/mm/yy", 
					changeYear: true, yearRange: "-100:+0", changeMonth: true,
					dayNames: dayNames, dayNamesMin: dayNamesMin, monthNames: monthNames });
				$("#patient-data-dob").datepicker({ dateFormat: "dd/mm/yy", 
					changeYear: true, yearRange: "-100:+0", changeMonth: true, 
					dayNames: dayNames, dayNamesMin: dayNamesMin, monthNames: monthNames });
				
				// Agrego handler para realizar efectivamente la búsqueda de estudios.
				$('#study-search-form').submit(function() {
					
					// HACK: Habilitamos temporalmente el control de fecha para que se incluyan los inputs 'disabled'.
					var fromDateDisabled = $("#study-date-between-from").prop('disabled');
					var toDateDisabled = $("#study-date-between-to").prop('disabled');

					$("#study-date-between-from").prop('disabled', false);
					$("#study-date-between-to").prop('disabled', false);
					
					var queryParameters = $(this).serialize();
					
					$("#study-date-between-from").prop('disabled', fromDateDisabled);
					$("#study-date-between-to").prop('disabled', toDateDisabled);
					
					// Realizamos la consulta al backend.
				    $.getJSON('rest/studies?' + queryParameters)
						  .done(function(result) {
							  	var dt = $('#studies-found').dataTable();
							  	dt.fnClearTable();
							  	if (result && result.length > 0)
							  		dt.fnAddData(result);
						  })
						  .fail(function() {
						    	alert('Ocurrió un error con su consulta de estudios. ' + 
						    		'Por favor, reintente la operación realizada.');
						  });				    
				    return false;
				});				
								
				// Agregar comportamiento para habilitar/deshabilitar fechas 'desde/hasta'
				// en la búsqueda de estudios.
				$.each($('input:radio[name="study-date-type"]'), function(index, item) {
					if (item.id == 'study-date-type-between')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', false);
							$("#study-date-between-to").prop('disabled', false);
							
							var fromDate = moment().startOf('day').toDate();
							var toDate = moment().toDate();
							$("#study-date-between-from").datepicker("setDate", fromDate);
							$("#study-date-between-to").datepicker("setDate", toDate);
						});
					else if (item.id == 'study-date-type-any')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', true);
							$("#study-date-between-to").prop('disabled', true);
							
							$("#study-date-between-from").datepicker("setDate", '');
							$("#study-date-between-to").datepicker("setDate", '');
							
							doSearch();
						});
					else if (item.id == 'study-date-type-today')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', true);
							$("#study-date-between-to").prop('disabled', true);
							
							var fromDate = moment().startOf('day').toDate();
							var toDate = moment().toDate();
							$("#study-date-between-from").datepicker("setDate", fromDate);
							$("#study-date-between-to").datepicker("setDate", toDate);
							
							doSearch();
						});
					else if (item.id == 'study-date-type-yesterday')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', true);
							$("#study-date-between-to").prop('disabled', true);

							var fromDate = moment().subtract(1, 'days').startOf('day').toDate();
							var toDate = moment().subtract(1, 'days').endOf('day').toDate();
							$("#study-date-between-from").datepicker("setDate", fromDate);
							$("#study-date-between-to").datepicker("setDate", toDate);
							
							doSearch();
						});
					else if (item.id == 'study-date-type-lastweek')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', true);
							$("#study-date-between-to").prop('disabled', true);
							
							var fromDate = moment().subtract(7, 'days').startOf('day').toDate();
							var toDate = moment().toDate();
							$("#study-date-between-from").datepicker("setDate", fromDate);
							$("#study-date-between-to").datepicker("setDate", toDate);
							
							doSearch();
						});
					else if (item.id == 'study-date-type-lastmonth')
						$(item).on('click', function() {
							$("#study-date-between-from").prop('disabled', true);
							$("#study-date-between-to").prop('disabled', true);
							
							var fromDate = moment().subtract(30, 'days').startOf('day').toDate();
							var toDate = moment().toDate();
							$("#study-date-between-from").datepicker("setDate", fromDate);
							$("#study-date-between-to").datepicker("setDate", toDate);
							
							doSearch();
						});
				});				
				
				// Agregar eventos a los botones relacionados a buscar estudios.
				$("#study-search-dosearch").on('click', function() {
					doSearch();
				});
				$("#study-search-clean").on('click', function() {
					$('#study-search-form')[0].reset();
				});				
				$("#study-search-close").on('click', function() {
					closeSearchBox();
				});
				
				// Configurar la grilla de resultados.
				$.fn.dataTable.moment( 'DD/MM/YYYY HH:mm' );
				$('#studies-found').dataTable({
					"data": [],
					"bStateSave": true,
					"lengthMenu": [ 10, 15, 20, 25, 30, 50, 75, 100 ],
					"order": [[ 7, "asc" ], [ 4, "asc" ]],
					"pageLength": 20,
					"dom": 'CT<"clear">lfrtip',
					"colVis": {
			            "exclude": [ 9, 10 ],
			            "label": function ( index, title, th ) {
			                return title;
			            }
			        },
					"tableTools": {
						"sRowSelect": "os",
						"aButtons": [
						              {
						                    "sExtends": "select_none",
						                    "sButtonText": "Desmarcar todo"
						              }						              
						],
						fnRowSelected: function(o) {
							studiesSelectionChanged();
						},
						fnRowDeselected: function(o) {
							studiesSelectionChanged();
						}											
					},
					"columns": [
						{ "title": "ID ESTUDIO", "data": "an", 
							"defaultContent": "?", "class": "center", "width": "80px" },
						{ "title": "ID PACIENTE", "data": "pid", 
								"defaultContent": "?", "class": "center", "width": "80px" },
						{ "title": "APELLIDO PACIENTE", "data": "pn", 
								"defaultContent": "<<NO DEFINIDO>>", "class": "center" },
						{ "title": "EDAD", "data": "age", 
								"defaultContent": "?", "class": "center", "width": "25px" },							
						{ "title": "FECHA ESTUDIO",	"data": "date", 
								"defaultContent": "??/??/???? ??:??", "class": "center", "width": "75px" },
						{ "title": "MODALIDAD", "data": "mod", 
								"defaultContent": "", "class": "center", "width": "25px" },
						{ "title": "DESCRIPCIÓN", "data": "desc", 
								"defaultContent": "", "class": "left" },
						{ "title": "ESTADO", "data": "rs", 
								"defaultContent": "?", "class": "center", "width": "25px" },
						{ "title": "#IMG", "data": "ti", 
								"defaultContent": "?", "class": "center", "width": "25px" },
						{ "title": "A", "data": "fc", 
								"defaultContent": "?", "class": "center", "width": "25px" },
						{ "title": "N", "data": "ns", 
								"defaultContent": "?", "class": "center", "width": "25px" }							
					],					
					"columnDefs": [
					               {
					            	   "targets": 7,
					            	   "render": function ( data, type, row ) {
					            		   if ( type === 'display' || type === 'filter' ) {
						            		   var url = 'rest/reporting/reports/pdf/' + row.id;
					            		   	
						                       return data==0 ? "<span class='study-report-status-tobeinformed'>A Informar</span>" : 
						                    	      data==1 ? "<span class='study-report-status-tobeconfirmed'>A Confirmar</span>" : 
						                    	      data==2 ? (actionIsAllowed(userinfo, row.iid, 'view-study-report') ? 
						                    		   				"<a href='" + url + "'><span class='study-report-status-informed'>Informado</span></a>" : 
						                    		   				"<span class='study-report-status-informed'>Informado</span>") : 
						                    			   "?";
					            		   }
					            		   return data; // Orden: 1ro: A Informar (data=0) ; 2do: A Confirmar (data=1) ; 3ro: Informado (data=2)
					                   }					                   
					               },
					               {
					            	   "targets": 9,
					            	   "render": function ( data, type, row ) {
					            		  if (!row.fc || row.fc <= 0) 
					            		   	  return "<span></span>";

					            		  var studyID = row.id;
					            		  var IID = row.iid;
					            		  var imgID = "clipimg-" + studyID;
					            		  return "<span><img id='" + imgID + "' " + 
					            		  			"src='../images/paperclip3_black.png' " + 
					            		  			"studyid='" + studyID +  "' " + 
					            		  			"iid='" + IID +  "' " + 
					            		  			"opcode='files' " + 
				            		      			"class='datable-row-icon' /></span>";					            		  
					                   }				                   
					               },
					               {
					            	   "targets": 10,
					            	   "render": function ( data, type, row ) {
					            		  if (!row.ns || row.ns != 1) 
					            		   	  return "<span></span>";

					            		  var studyID = row.id;
					            		  var IID = row.iid;
					            		  var imgID = "notesimg-" + studyID;
					            		  return "<span><img id='" + imgID + "' " + 
					            		  			"src='../images/notes.png' " + 
					            		  			"studyid='" + studyID +  "' " + 
					            		  			"iid='" + IID +  "' " + 
					            		  			"opcode='notes' " + 
				            		      			"class='datable-row-icon' /></span>";					            		  
					                   }				                   
					               }					               					               
					               					               
					           ],
					"language": {
			            "lengthMenu": "Mostrar _MENU_ estudios por página",
			            "zeroRecords": "No se encontraron registros para mostrar con los criterios especificados.",
			            "info": "Mostrando página _PAGE_ de _PAGES_",
			            "infoEmpty": "Sin estudios para mostrar",
			            "infoFiltered": "(filtrados de un total de _MAX_ estudios)",
					    "emptyTable":     "Sin estudios para mostrar",
					    "infoPostFix":    "",
					    "thousands":      ".",
					    "loadingRecords": "Cargando...",
					    "processing":     "Procesando...",
					    "search":         "Buscar:",
					    "paginate": {
					        "first":      "Primera",
					        "last":       "Última",
					        "next":       "Siguiente",
					        "previous":   "Anterior"
					    },
					    "aria": {
					        "sortAscending":  ": Click para ordenar ascendentemente",
					        "sortDescending": ": Click para ordenar descendentemente"
					    }
					}				
				});

				var colvis = new $.fn.dataTable.ColVis( $('#studies-found').dataTable() );
				
				$("#studies-found").on('mouseover', 'img.datable-row-icon', function() {
					if($(".ui-dialog").is(":visible"))
						return;
					
					var studyID = this.attributes["studyid"].value;
					var opcode = this.attributes["opcode"].value;
					var iid = this.attributes["iid"].value;								
					
					if (opcode == 'files' && actionIsAllowed(userinfo, iid, 'view-study-files'))
			        	openStudyFilesDialog(studyID, 'Archivos', false, false);
					else if (opcode == 'notes' && actionIsAllowed(userinfo, iid, 'view-study-notes'))
			        	openStudyNotesDialog(studyID, 'Observaciones', false, false);
			    });
								
				// Menu contextual con las acciones para los estudios encontrados
				$("#studies-found").contextmenu({
					delegate: ".selected",
					menu: [
					        { title: "Visualización simple", cmd: "study-simple-view", uiIcon: "ui-icon-zoomout" },
					        { title: "Visualización avanzada", cmd: "study-advanced-view", uiIcon: "ui-icon-zoomin" },
					        { title: "Ver informe", cmd: "study-view-report", uiIcon: "ui-icon-note" },
					        { title: "Editar informe", cmd: "study-edit-report", uiIcon: "ui-icon-pencil" },
					        { title: "Archivos", cmd: "study-files", uiIcon: "ui-icon-disk" },
					        { title: "DICOMDIR", cmd: "study-dicomdir", uiIcon: "ui-icon-folder-collapsed" },
					        { title: "Observaciones", cmd: "study-notes", uiIcon: "ui-icon-pin-w" }					        
					      ],
				    select: function(event, ui) {
				        if (ui.cmd == 'study-simple-view')
				        	simpleVisualization();
				        else if (ui.cmd == 'study-advanced-view')
				        	advancedVisualization();
				        else if (ui.cmd == 'study-view-report')
				        	viewReport();
				        else if (ui.cmd == 'study-edit-report')
				       		editReport();
				        else if (ui.cmd == 'study-files')
				       		viewFiles();
				        else if (ui.cmd == 'study-dicomdir')
				        	downloadDICOMDIR();
				        else if (ui.cmd == 'study-notes')
				        	editNotes();
				    },
				    beforeOpen: function(event, ui) {
				        var study = null,
				        	$menu = ui.menu,
				            $target = ui.target,
				            extraData = ui.extraData; // optionally passed when menu was opened by call to open()
				            

						var selectedRow = $('#studies-found').DataTable().row('.selected');
				        if (selectedRow && selectedRow.data())
				        	study = selectedRow.data();
				        else
				        	// Evitamos abrir el menu si no hay un estudio seleccionado.
				        	return false;
				            
				        $("#studies-found").contextmenu("enableEntry", 'study-simple-view',
				        		actionIsAllowed(userinfo, study.iid, 'simple-study-visualization'));
				        $("#studies-found").contextmenu("enableEntry", 'study-advanced-view',
				        		actionIsAllowed(userinfo, study.iid, 'advanced-study-visualization'));
				        $("#studies-found").contextmenu("enableEntry", 'study-view-report',
				        		actionIsAllowed(userinfo, study.iid, 'view-study-report'));
				        $("#studies-found").contextmenu("enableEntry", 'study-edit-report',
				        		actionIsAllowed(userinfo, study.iid, 'edit-study-report'));
				        $("#studies-found").contextmenu("enableEntry", 'study-files',
				        		actionIsAllowed(userinfo, study.iid, 'view-study-files'));
				        $("#studies-found").contextmenu("enableEntry", 'study-dicomdir',
				        		actionIsAllowed(userinfo, study.iid, 'access-study-dicomdir'));
				        $("#studies-found").contextmenu("enableEntry", 'study-notes',
				        		actionIsAllowed(userinfo, study.iid, 'edit-study-notes'));				        
				    }
				});								
				
				// Agregado de comportamiento para los botones que actuan sobre los estudios encontrados.
				disableAllStudyActions();				
				
				$('#study-simple-view').click(function() {
					simpleVisualization();
			    });
				
				$('#study-advanced-view').click(function() {
					advancedVisualization();
			    });				
	
				$('#study-view-report').click(function() {
					viewReport();
			    });
				
				$('#study-edit-report').click(function() {
					editReport();
			    });				

				$('#study-files').click(function() {
					viewFiles();
			    });			
				
				$('#study-dicomdir').click(function() {
					downloadDICOMDIR();
			    });							

				$('#study-notes').click(function() {
					editNotes();
			    });							
				
				// Configurar la validación de los campos de los controles de búsqueda de estudios.
				$("#study-search-form").validate({
					rules: {
						"study-accessionnumber": {
							required: false,
							maxlength: 100
						},							
						"study-date-between-from": {
							required: "#study-date-type-between:checked",
							maxlength: 100
						},
						"study-date-between-to": {
							required: "#study-date-type-between:checked",
							maxlength: 100
						},							
						"patient-data-id": {
							required: false,
							maxlength: 100
						},							
						"patient-data-name": {
							required: false,
							maxlength: 100
						},							
						"patient-data-dob": {
							required: false,
							maxlength: 100
						}							
					},
					messages: {
						"study-date-between-from": "Ingrese una fecha inicial",
						"study-date-between-to": "Ingrese una fecha final"
					}
				});				
			});

			function doSearch() {
				$("#study-search-form").validate();
				if ($("#study-search-form").valid())
					$('#study-search-form').submit();				
			}
			
			function getSelectedStudies() {
		    	var oTT = TableTools.fnGetInstance('studies-found');
			    return oTT.fnGetSelectedData();								
			}
			
			function studiesSelectionChanged() {
		    	disableAllStudyActions();
				var selectedStudies = getSelectedStudies();
			    
			    if (selectedStudies.length <= 0) {
			    	return;
			    } else if (selectedStudies.length == 1) {
			    	onStudySelected(selectedStudies[0]);
			    } else {
			    	var getReportOK = true;
			    	var dicomdirOK = true;
				    $.each(selectedStudies, function(index, study) {
				    	getReportOK = getReportOK && actionIsAllowed(userinfo, study.iid, 'view-study-report');
				    	dicomdirOK = dicomdirOK && actionIsAllowed(userinfo, study.iid, 'access-study-dicomdir');
				    });
				    
					$('#study-view-report').button('option', 'disabled', !getReportOK);
					$('#study-dicomdir').button('option', 'disabled', !dicomdirOK);				    
			    }
			}			
			
			function onStudySelected(study) {
				$('#study-simple-view').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'simple-study-visualization'));				
				$('#study-advanced-view').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'advanced-study-visualization'));				
				$('#study-view-report').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'view-study-report'));				
				$('#study-edit-report').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'edit-study-report'));				
				$('#study-files').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'view-study-files'));					
				$('#study-dicomdir').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'access-study-dicomdir'));						
				$('#study-notes').button('option', 'disabled', !actionIsAllowed(userinfo, study.iid, 'edit-study-notes'));								
			}
			
			function disableAllStudyActions() {
				$('#study-simple-view').button('option', 'disabled', true);				
				$('#study-advanced-view').button('option', 'disabled', true);	
				$('#study-view-report').button('option', 'disabled', true);
				$('#study-edit-report').button('option', 'disabled', true);
				$('#study-files').button('option', 'disabled', true);
				$('#study-dicomdir').button('option', 'disabled', true);
				$('#study-notes').button('option', 'disabled', true);
			}
			
			function updateStudyData(updatedStudyID) {
				$.getJSON("rest/studies/" + updatedStudyID)
				  .done(function(info) {
					  var dt = $('#studies-found').DataTable();
					  
					  $.each(dt.data(), function (index, rowData) {
						if (rowData.id == updatedStudyID) {
							dt.row(index).data(info);
							dt.rows().invalidate().draw(); 
							return false;
						}
					  });
				  })
				  .fail(function() {
				    alert('Ocurrió un error intentando actualizar la información actualmente presentada. ' + 
				    	'Por favor, realize una nueva búsqueda de estudios.');
				  });
			} 
			
			function getConfig(name) {
				var entry = $.grep(ddConfig, function(element, index){
				      return element.name == name;
				});
				
				if (entry && entry.length > 0)
					return entry[0].value;
				return null;
			}
			
			function simpleVisualization() {
				var selectedRow = $('#studies-found').DataTable().row('.selected');
		        if (selectedRow && selectedRow.data()) {
		        	var studyID = selectedRow.data().id;
		        	var url = getConfig('actions.study.simple-view.url').replace('${STUDYID}', studyID) ;
		        	window.open(url, 'Visualización simple para estudio: ' + studyID, 800, 600);
		        }
		        else 
		        	alert('Por favor, seleccione un estudio previo a realizar esta acción.');
			}

			function advancedVisualization() {
				var selectedRow = $('#studies-found').DataTable().row('.selected');
		        if (selectedRow && selectedRow.data()) {
		        	var studyID = selectedRow.data().id;
		        	var url = getConfig('actions.study.advanced-view.url').replace('${STUDYID}', studyID) ;
		        	window.open(url, 'Visualización avanzada para estudio: ' + studyID, 800, 600);
		        }
		        else 
		        	alert('Por favor, seleccione un estudio previo a realizar esta acción.');
			}

			function viewReport() {
				var selectedStudies = getSelectedStudies();				
		        if (selectedStudies.length <= 0) {
		        	alert('Por favor, seleccione uno o más estudios previo a realizar esta acción.');
		        } else {
		        	var reportURLs = [];
				    $.each(selectedStudies, function(index, study) {
			        	var isReported = study.rs == 2;			        	
			        	if (isReported) {
				    		var url = 'rest/reporting/reports/pdf/' + study.id;
				    		reportURLs.push(url);
			        	}
				    });
				    
				    if(reportURLs.length > 0) {
				    	$.each(reportURLs, function(index, url) {
				    		$.fileDownload(url);
				    	});
				    } else {
				    	if (selectedStudies.length > 1)
					    	alert('No se encontraron estudios con informe cerrado entre los seleccionados.');
				    	else
			        		alert('No se ha emitido un informe todavía para el estudio seleccionado.');
				    }
		        }
			}
			
			function editReport() {
				var selectedRow = $('#studies-found').DataTable().row('.selected');
		        if (selectedRow && selectedRow.data()) {
		        	var studyID = selectedRow.data().id;
		        	var patientName = selectedRow.data().pn;
		        	var patientAge = selectedRow.data().age;
		        	var isReported = selectedRow.data().rs == 2;
		        	
		        	if (isReported)
		        		alert('El estudio ya ha sido informado.');
		        	else {
		        		var url = 'edit-study-report.html?s=' + studyID;
		        		$("#dynamicModalDialog").dialog({
		        			height: 600,
		        			width: 800,
		        			closeOnEscape: true,
		        			closeText: "Cerrar",
		        			modal: true,
		        			title: 'Editar informe para el paciente: ' + patientName + ' - Edad: ' + patientAge, 
		        			open: function(ev, ui) {					        				
		        				$('#dynamicModalDialogIframe').attr('src', url);
		        			}
		        		});				        		
		        	}
		        }
		        else 
		        	alert('Por favor, seleccione un estudio previo a realizar esta acción.');				
			}
			
			function viewFiles() {
				var selectedRow = $('#studies-found').DataTable().row('.selected');
		        if (selectedRow && selectedRow.data()) {
		        	var studyID = selectedRow.data().id;
		        	var patientName = selectedRow.data().pn;
		        	var patientAge = selectedRow.data().age;
		        	var isReported = selectedRow.data().rs == 2;
		        	var title = 'Archivos para estudio del paciente: ' + patientName + ' - Edad: ' + patientAge;
		        	
		        	openStudyFilesDialog(studyID, title, true, true);
		        }
		        else 
		        	alert('Por favor, seleccione un estudio previo a realizar esta acción.');				
			}
			
			function editNotes() {
				var selectedRow = $('#studies-found').DataTable().row('.selected');
		        if (selectedRow && selectedRow.data()) {
		        	var studyID = selectedRow.data().id;
		        	var patientName = selectedRow.data().pn;
		        	var patientAge = selectedRow.data().age;
		        	var isReported = selectedRow.data().rs == 2;
		        	var title = 'Observaciones para estudio del paciente: ' + patientName + ' - Edad: ' + patientAge;
		        	
		        	openStudyNotesDialog(studyID, title, true, true);
		        }
		        else 
		        	alert('Por favor, seleccione un estudio previo a realizar esta acción.');				
			}
			
			function openStudyFilesDialog(studyID, title, modal, editMode) {			
        		var url = 'study-files.html?s=' + studyID + '&e='+(editMode ? 1:0);
        		var dialogHeight = editMode ? 600 : 410;
        		var hideEffect = editMode ? null : { effect: "fade", duration: 400 };
        		var dialogWidth = 800;
        		
           		$("#dynamicModalDialog").dialog({
           			height: dialogHeight,
           			width: dialogWidth,
           			closeOnEscape: true,
           			closeText: "Cerrar",
           			modal: modal,
           			title: title,
           			hide: hideEffect,
           			clickOutside: !editMode,
           			open: function(ev, ui) {					        				
           				$('#dynamicModalDialogIframe').attr('src', url);
           			}
           		});				        						        			
			}
			
			function openStudyNotesDialog(studyID, title, modal, editMode) {			
        		var url = 'study-notes.html?s=' + studyID + '&e='+(editMode ? 1:0);
        		var dialogHeight = editMode ? 600 : 350;
        		var hideEffect = editMode ? null : { effect: "fade", duration: 400 };
        		var dialogWidth = 800;
        		
           		$("#dynamicModalDialog").dialog({
           			height: dialogHeight,
           			width: dialogWidth,
           			closeOnEscape: true,
           			closeText: "Cerrar",
           			modal: modal,
           			title: title,
           			hide: hideEffect,
           			clickOutside: !editMode,
           			open: function(ev, ui) {					        				
           				$('#dynamicModalDialogIframe').attr('src', url);
           			}
           		});				        						        			
			}
			
			function downloadDICOMDIR() {
				var selectedStudies = getSelectedStudies();				
		        if (selectedStudies.length <= 0) {
		        	alert('Por favor, seleccione uno o más estudios previo a realizar esta acción.');
		        } else if (selectedStudies.length == 1) {
		        	var selectedRow = selectedStudies[0]; 
		        	var studyID = selectedRow.id;		        	
	        		var url = 'rest/studies/' + studyID + '/media';	        		
	        		window.setTimeout(function() { doUnblockUI(); }, 3000);
	        		doBlockUI();
	        		$.fileDownload(url);
		        } else { 
		        	var reportURLs = [];
				    $.each(selectedStudies, function(index, study) {
				    	var url = 'rest/studies/' + study.id + '/media';
				    	reportURLs.push(url);
				    });
				    
				    if(reportURLs.length > 0) {
				    	$.each(reportURLs, function(index, url) {
				    		$.fileDownload(url);
				    	});
		        		window.setTimeout(function() { doUnblockUI(); }, 3000);
		        		doBlockUI();		    	
				    } else {
				    	alert('No se encontraron estudios sobre los cuales se pueda generar DICOMDIR.');
				    }
		        }
			}
			
			function closeSearchBox() {
				mainLayout.toggle('west');				
			}
			
			function closeModalDialog() {
				$('#dynamicModalDialogIframe').attr('src', 'about:blank');
				$("#dynamicModalDialog").dialog("close");
			}
			
			function readUserInfo() {
				$.getJSON("rest/user/info")
				  .done(function(info) {
					  	userinfo = info;
				    	$('#userinfo').text(info.login + ' [' + info.lastName + ', ' + info.firstName +  ']');

			    		$("#study-search-modalities-container").html("");			    		
				    	if (info.modalities && info.modalities.length > 0) {
				    		var ITEMS_PER_COLUMN = 5;
				    		var columnWidth = "16%";
				    		
				    		var radiosHTML = "<div style='float:left; width:" + columnWidth + ";'>";
				    		radiosHTML += "<div class='study-search-modality'><input id='study-search-all-modalities' type='radio' " +
				    			"name='study-modality' value='' checked='checked' />" + 
				    			"<label for='study-search-all-modalities'>Todas</label></div>";				            
				    			
					    	$.each(info.modalities, function(index, modality) {
					    		if (((index+1) % ITEMS_PER_COLUMN) == 0)
					    			radiosHTML += "</div><div style='float:left; width:" + columnWidth + ";'>";
					    		
					    		var controlID = 'study-search-modality-' + modality.name;
					    		radiosHTML += "<div class='study-search-modality'><input id='" + controlID + "' type='radio' name='study-modality' value='" + modality.name + "' />" + 
				    				"<label for='" + controlID + "'>" + modality.name + "</label></div>";					            
					        });					    	
					    	radiosHTML += "</div>";
					    	
					    	$(radiosHTML).appendTo("#study-search-modalities-container");
				    	}
				  })
				  .fail(function() {
				    	window.location.href = '../authentication-servlet/logout';
				  });
			}
		</script>
	</head>
	<body>
		<div class="ui-layout-center">
			<div>
				<table id="studies-found" class="display"></table>
			</div>
			<div id="studies-found-actions-container">
				<button type="button" id="study-simple-view" class="study-action-button">
					Visualizaci&oacute;n simple</button>
				<button type="button" id="study-advanced-view" class="study-action-button">
					Visualizaci&oacute;n avanzada</button>
				<button type="button" id="study-view-report" class="study-action-button">
					Ver informe</button>
				<button type="button" id="study-edit-report" class="study-action-button">
					Editar informe</button>
				<button type="button" id="study-files" class="study-action-button">
					Archivos</button>
				<button type="button" id="study-dicomdir" class="study-action-button">
					DICOMDIR</button>
				<button type="button" id="study-notes" class="study-action-button">
					Observaciones</button>
			</div>			
		</div>
		<div class="ui-layout-north">
			<div class="top-of-page-layout-west">
				<img src="../images/ddlogo.png" class="top-of-page-logo" alt="Diagn&oacute;stico Digital logo" />
			</div>
			<div class="top-of-page-layout-center">
				<font class="top-of-page-title-text">Administrador de estudios</font>
			</div>
			<div class="top-of-page-layout-east">
				<label>Diagn&oacute;stico Digital - DDWEB</label>&nbsp;&nbsp;|&nbsp;
				<label id="userinfo"></label>&nbsp;&nbsp;|&nbsp; 
				<a href="../authentication-servlet/logout">Cerrar sesi&oacute;n</a>
			</div>
		</div>
		<div class="ui-layout-south">
			Diagn&oacute;stico Digital - DDWEB&nbsp;&nbsp;|&nbsp;&nbsp;&copy; 
			2014 Diagn&oacute;stico Digital&nbsp;&nbsp;|&nbsp;&nbsp;Todos los derechos reservados
		</div>
		<div class="ui-layout-west">
			<div class="study-layout-north">
				<label>Buscar estudios</label>
			</div>
			<div class="study-layout-center">
				<form id="study-search-form" name="study-search-form">
					<div id="date-study-search-field-group" class="study-search-field-group" style="margin-top: 0em !important;">
						<div><label class="study-search-field-group-title">Fechas:</label></div>
						<div>
							<input type="radio" id="study-date-type-any" name="study-date-type" value="1" checked="checked" />
							<label class="filter-field-label" for="study-date-type-any">Cualquier d&iacute;a</label>
						</div>
						<div>
							<input type="radio" id="study-date-type-today" name="study-date-type" value="2" />
							<label class="filter-field-label" for="study-date-type-today">Hoy</label>
						</div>
						<div>
							<input type="radio" id="study-date-type-yesterday" name="study-date-type" value="3" />
							<label class="filter-field-label" for="study-date-type-yesterday">Ayer</label>
						</div>
						<div>
							<input type="radio" id="study-date-type-lastweek" name="study-date-type" value="4" />
							<label class="filter-field-label" for="study-date-type-lastweek">&Uacute;ltima semana</label>
						</div>
						<div>
							<input type="radio" id="study-date-type-lastmonth" name="study-date-type" value="5" />
							<label class="filter-field-label" for="study-date-type-lastmonth">&Uacute;ltimo mes</label>
						</div>
						<div>
							<div>
								<input type="radio" id="study-date-type-between" name="study-date-type" value="6" />
								<label class="filter-field-label" for="study-date-type-between">Entre:</label>
							</div>
							<div>
								<div>
									<label class="filter-field-label" for="study-date-between-from">Desde:</label>
									<input type="text" id="study-date-between-from" name="study-date-between-from"
										disabled="disabled" />
								</div>
								<div>
									<label class="filter-field-label" for="study-date-between-to">Hasta:</label>
									<input type="text" id="study-date-between-to" name="study-date-between-to" 
										disabled="disabled" />
								</div>
							</div>
						</div>
					</div>
					
					<div class="study-search-field-group">
						<div><label class="study-search-field-group-title">Datos del paciente:</label></div>
						<div>
							<label class="filter-field-label" for="patient-data-id">ID Paciente:</label>
							<input type="text" id="patient-data-id" name="patient-data-id" />
						</div>
						<div>
							<label class="filter-field-label" for="patient-data-name">Nombre:</label>
							<input type="text" id="patient-data-name" name="patient-data-name" />
						</div>
						<div>
							<label class="filter-field-label" for="study-accessionnumber">N&uacute;mero de estudio:</label>
							<input type="text" id="study-accessionnumber" name="study-accessionnumber" />
						</div>
						<div>
							<label class="filter-field-label" for="patient-data-dob">Fecha nacimiento:</label>
							<input type="text" id="patient-data-dob" name="patient-data-dob" 
								readonly="readonly" />
						</div>
					</div>					

					<div class="study-search-field-group">
						<div><label class="study-search-field-group-title">Modalidades:</label></div>
						<div id="study-search-modalities-container" class="clearfix">
							<!-- Carga en base a info de usuario.  -->
						</div>
					</div>					
					<div class="study-search-button-container">
						<button type="button" id="study-search-dosearch">Buscar</button>
						<button type="button" id="study-search-clean">Limpiar</button>
						<button type="button" id="study-search-close">Cancelar</button>
					</div>
				</form>
			</div>						
			<div class="study-layout-south">
			</div>
		</div>
		<div id="dynamicModalDialog">
			<iframe id="dynamicModalDialogIframe" src=""></iframe>					
		</div>
	</body>
</html>