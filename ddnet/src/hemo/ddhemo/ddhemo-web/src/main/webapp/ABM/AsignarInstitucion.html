<html>
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />

		<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="../js/jquery-ui.js"></script>
		<script type="text/javascript" src="../js/purl.js"></script>
		<script type="text/javascript" src="../js/css_browser_selector.js"></script>

		<link rel="stylesheet" type="text/css" href="../css/jquery-ui-1.10.4.css" />


<style type="text/css">

body {

	background: #bea;
}

button {

	width: 100px;
}

.ui-widget {

	font-size: 0.8em;
}

#divInst {
	
	text-align: left;
	font-size: 0.9em;
}

label {

	width: 200px;
	display: inline-block;
}

.chrome br.plus {
	
	display: none;
}

.chrome br {

	line-height: 1em;
}

br {

	line-height: 0.5em;
}

</style>

<script type="text/javascript">

var login = null;
var Fname = null;
var Lname = null;
var Rname = null;
var Iname = [];
var isNew = null;
var dialog;


$(document).ready(function() {
	
	login = $.url().param('login');
	Fname = $.url().param('Fname');
	Lname = $.url().param('Lname');
	Rname = $.url().param('Rname');
	isNew = $.url().param('new') == 'true';
	dialog = window.parent.$("#dynamicModalDialog");
	
	init();
	
	if(isNew) {
		dialog.dialog( 'option', 'title', 'ASIGNAR INSTITUCIONES A USUARIO' );
		$('#btnInst').button({ icons: { primary: 'ui-icon-circle-check' } })
						.on('click' , function() { assignInstitution_new(); });
		$('#btnCancelar').button({ icons: { primary: 'ui-icon-circle-close' } })
							.on('click' , function() { if(confirm('Si no confirma las asignaciones,\n'+
															'el nuevo usuario "'+login+'" se borrará')) deleteUser(); });
	}
	else{
		dialog.unbind('dialogbeforeclose');
		$('#btnInst').button({ icons: { primary: 'ui-icon-circle-check' } })
						.on('click' , function() { assignInstitution(); });
		$('#btnCancelar').button({ icons: { primary: 'ui-icon-circle-close' } })
							.on('click' , function() { dialog.dialog('close'); });
		
		$.getJSON('../restricted/rest/abm/userinstitution/' + login)
		.done( function(data){
			if(data && data.length > 0){
			$.each(data, function(ind, i){$('input[type="checkbox"][value="'+i.id+'"]').prop('checked', true)
																					   .removeClass('0')
																					   .addClass('1');} );	
			}});	
	}
});

function init(){
	
	$('#spnData').text(login + ' ( ' + Fname + ' ' +  Lname +  ' )');
	$('#spnData1').text(Rname);
	
	$.getJSON("../restricted/rest/abm/allinstitutions")
	.done(function(data) {
		
	if(data && data.length > 0){
			
		$.each(data, function(i , inst) {
				
		var check = "<input type='checkbox' class='0' id='inst_" + inst.name + "' value='" + inst.id + "' />" 
						+ "<label for='inst_" + inst.name + "'>" + inst.name + "</label>";
				
		$('#divInst').append("<br><br class='plus'>" + check );
	});}})
	.fail(function(){alert('ERROR al cargar las instituciones');});
	
	var margen = ( $('body').width() - 216 ) / 2 ;
	
	$('#divInst').css( 'padding-left' , margen+'px');
}


function getSelectedCheckBox() {
	
	if( $('input:checked').length == 0 ) {alert("seleccione al menos una institución");
											return null;}

	else{
		var IDs = [[],[]];
		$.each( $('input[type="checkbox"][class="0"]:checked') , function( i , chk ) { IDs[1].push(chk.value); });
		$.each( $('input[type="checkbox"][class="1"]:not(:checked)') , function( i , chk ) { IDs[0].push(chk.value); });	
	}
	
	return IDs;
}

function getSelectedCheckBox_new() {
	
	if( $('input:checked').length == 0 ) {	alert("seleccione al menos una institución");
											return null;	}
	
	else {
		var IDs = [];
		$.each( $('input[type="checkbox"]:checked') , function( i , chk ) {
			IDs.push(chk.value);
			Iname.push(chk.id.replace('inst_','')); 
		});
	}
	
	return IDs;
}

function assignInstitution() {
	
	var IDs = getSelectedCheckBox();
 	if(IDs != null){
		var dto = {
				loginname: login,
		    	roleName: Rname,
		    	instIDs0: IDs[0],
		    	instIDs1: IDs[1]	};
		$.ajax({
	  		type: "POST",
	  		url: '../restricted/rest/abm/userinstitution',
	  		data: dto,
	  		success: function() { alert('instituciones asignadas');
	  							  dialog.dialog("close");
	  							  window.parent.CargarTablaUsuario(window.parent.tablaU.dataTable());
	  							  window.parent.$('#btnAssignInstitution').button('option','disabled',true);},
			error: function() { alert('Ocurrió un error al momento de asignar');
								window.parent.$("#dynamicModalDialog").dialog("close");}
	});
	} 
}


function assignInstitution_new() {
	
	var IDs = getSelectedCheckBox_new();
	if(IDs != null){
		var dto = {
				loginname: login,
    			roleName: Rname,
    			instIDs: IDs	};
		$.ajax({
	  		type: "POST",
	  		url: '../restricted/rest/abm/userinstitution/new',
	  		data: dto,
	  		success: function() { alert('instituciones asignadas');
	  							  var url = '../ABM/AsignarModalidad.html?login=' + login + '&Fname=' + Fname + '&Lname=' + Lname
												+ '&Rname=' + Rname + '&Iname=' + Iname + '&new=true'; 
							  	  window.parent.$("#dynamicModalDialogIframe").attr('src' , url);},
			error: function() { alert('Ocurrió un error al momento de asignar');
								dialog.unbind('dialogbeforeclose');
								dialog.dialog("close");}
	});
	}
}

function deleteUser(){
	
	$.post('../restricted/rest/abm/deleteUser', 'login='+login);
	dialog.unbind('dialogbeforeclose');
	dialog.dialog('close');
}

</script>


</head>

<body>

<span style="font-weight: bold; font-size:0.9em">Usuario: </span><span id="spnData" style="font-size: 0.85em;"></span>

<br>

<span style="font-weight: bold; font-size:0.9em">Rol: </span><span id="spnData1" style="font-size: 0.85em;"></span>

<br><br>

<span style="font-weight: bold; font-size: 0.8em;">Seleccione las instituciones a las que pertenece.</span>

<br><br class='plus'>

<div id="divInst"></div>

<br><br><br class='plus'><br class='plus'>

<div align="center">
<button id="btnInst">Asignar</button>
&nbsp;&nbsp;
<button id="btnCancelar">Cancelar</button>
</div>

</body>

</html>