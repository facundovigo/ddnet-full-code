<!DOCTYPE html>
<html>
	<head>
		<title>Edici&oacute;n de informe</title>
		
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		
		<link rel="stylesheet" type="text/css" href="../css/jquery-ui-1.10.4.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout-default.css" />		
		<link rel="stylesheet" type="text/css" href="../css/main.css" />
		<link rel="stylesheet" type="text/css" href="../css/edit-study-report.css" />
		<link rel="stylesheet" type="text/css" href="../css/jquery.dataTables.css">
		
		<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="../js/jquery-ui-1.10.4.js"></script>
		<script type="text/javascript" src="../js/jquery.layout-1.3.0.js"></script>
		<script type="text/javascript" src="../js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="../js/jquery.validate.js"></script>
		<script type="text/javascript" src="../js/jquery.blockUI.js"></script>		
		<script type="text/javascript" src="../js/purl.js"></script>
		
		<script type="text/javascript">
			var mainLayout = null;
			var studyID = null;
			var modality = null;
			
			$(document).ready(function() {
				studyID = $.url().param('s');
				document.title += ' - Estudio: ' + studyID;
								
				mainLayout = $('body').layout({
					north__paneSelector:	".edit-study-report-layout-north",
					south__paneSelector:	".edit-study-report-layout-south",
					center__paneSelector:	".edit-study-report-layout-center",
										
					north__closable : false,
					north__resizable : false,
					north__spacing_open : 0,
					north__spacing_closed : 0
		
					,
					south__closable : false,
					south__resizable : false,
					south__spacing_open : 0,
					south__spacing_closed : 0
					
					,
					center__closable : false,
					center__resizable : false,
					center__spacing_open : 0,
					center__spacing_closed : 0
				});
				
				$('#edit-study-report-finish').button
				({
				    icons: { primary: "ui-icon-document" }, text: true
				});
				$('#edit-study-report-save').button
				({
				    icons: { primary: "ui-icon-disk" }, text: true
				});
				$('#edit-study-report-exit').button
				({
				    icons: { primary: "ui-icon-close" }, text: true
				});
				$('#edit-study-report-insert-template').button
				({
				    icons: { primary: "ui-icon-check" }, text: true
				});
				
				$('#edit-study-report-insert-template').click(function() {
					var templateName = $('#reportTemplates').val();
					if (!templateName || !studyID)
						return;
					
					if ($('#report-body-editor').val().trim())
						if (!confirm('ATENCIÓN: Ya existe texto ingresado. Si continúa, el mismo será sobreescrito.\n' +
									 ' ¿Confirma la utilización del protocolo base seleccionado?'))
							return;
					
					$.getJSON("rest/reporting/templates/modalities/" + modality + "/" + templateName + '?study-id=' + studyID)
					  .done(function(info) {
						  $('#report-body-editor').val(info.body);
					  })
					  .fail(function() {
					    alert('Ocurrió un error en la comunicación con el servidor. ' + 
					    	'Por favor, reintente la operación realizada.');
					  });
				});				

				$('#edit-study-report-finish').click(function() {
					if (!studyID)
						return;
					
					if (!confirm('¿Confirma la finalización y cierre de este informe? No podrá volver a modificarlo una vez cerrado.'))
						return;
					
					$('#finished-flag').val('true');
					var form = $('form[name="report-data"]');
					
					$.post("rest/studies/" + studyID + "/report/body", form.serialize())
					  .done(function(info) {
						  $('#edit-study-report-finish').prop('disabled', true);
						  $('#edit-study-report-save').prop('disabled', true);
						  $('#report-body-editor').prop('disabled', true);
						  
						  if (window.parent) {
							  if (window.parent.updateStudyData)
							  	window.parent.updateStudyData(studyID);
							  if (window.parent.closeModalDialog)
								  window.parent.closeModalDialog();
						  }
					  })
					  .fail(function() {
					    alert('Ocurrió un error en la comunicación con el servidor. ' + 
					    	'Por favor, reintente la operación realizada.');
					  });
				});				

				$('#edit-study-report-save').click(function() {
					if (!studyID)
						return;
					
					if (!confirm('¿Confirma la grabación de los cambios introducidos? El informe quedará marcado \r\ncomo "A confirmar" para permitir posteriores modificaciones.'))
						return;
					
					$('#finished-flag').val('false');
					var form = $('form[name="report-data"]');
					
					$.post("rest/studies/" + studyID + "/report/body", form.serialize())
					  .done(function(info) {
						  if (window.parent && window.parent.updateStudyData)
							  window.parent.updateStudyData(studyID);						  
					  })
					  .fail(function() {
					    alert('Ocurrió un error en la comunicación con el servidor. ' + 
					    	'Por favor, reintente la operación realizada.');
					  });
				});				

				$('#edit-study-report-exit').click(function() {
					if (window.parent.closeModalDialog)
						window.parent.closeModalDialog();					
				});				
				
				getCurrentData();				
			});
			
			function populateTemplates() {
				$.getJSON("rest/reporting/templates/modalities/" + modality)
				  .done(function(info) {
						var templatesSelector = $('#reportTemplates'); 
						templatesSelector.empty();
				    	if (info && info.length > 0) {
					    	$.each(info, function(index, template) {
					    		templatesSelector.append('<option value="' + template + '">' + template + '</option>');
					        });
				    	}
				  })
				  .fail(function() {
					$('.edit-study-report-layout-north').find('label').text('No se encontraron plantillas para esta modalidad.');
				    $('#reportTemplates').remove();
					$("#edit-study-report-insert-template").remove();
				  });
			}
			
			function getCurrentData() {
				$('#report-body-editor').val('');
				$.getJSON("rest/studies/" + studyID)
				  .done(function(info) {
					  modality = info.mod;
					  populateTemplates();
				  })
				  .fail(function() {
				    alert('Ocurrió un error en la comunicación con el servidor. ' + 
				    	'Por favor, reintente la operación realizada.');
					  if (window.parent.closeModalDialog)
						  window.parent.closeModalDialog();
				  });

				$.get("rest/studies/" + studyID + '/report/body')
				  .done(function(info) {
					  $('#report-body-editor').val(info);
				  })
				  .fail(function() {
				    alert('Ocurrió un error en la comunicación con el servidor. ' + 
				    	'Por favor, reintente la operación realizada.');
					  if (window.parent.closeModalDialog)
						  window.parent.closeModalDialog();
				  });
			}
		</script>
	</head>
	<body>
		<div class="edit-study-report-layout-north">
			<label>Protocolos base:</label>
			<select id="reportTemplates"></select>
			<button type="button" id="edit-study-report-insert-template">
				Abrir</button>
		</div>
		<form id="report-data" name="report-data" method="post">
			<div class="edit-study-report-layout-center">
				<textarea id="report-body-editor" name="report-body">
				</textarea>
			</div>
			<input type="hidden" id="finished-flag" name="finished" />
		</form>
		<div class="edit-study-report-layout-south">
			<button type="button" id="edit-study-report-finish" class="edit-study-report-action-button">
				Cerrar informe</button>
			<button type="button" id="edit-study-report-save" class="edit-study-report-action-button">
				Guardar cambios</button>
			<button type="button" id="edit-study-report-exit" class="edit-study-report-action-button">
				Salir</button>
		</div>		
	</body>
</html>
	