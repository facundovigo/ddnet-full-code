<!DOCTYPE html>
<html>
<head>
<title>Archivos adjuntos</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<link rel="stylesheet" type="text/css"
	href="../css/jquery-ui-1.10.4.css" />
<link rel="stylesheet" type="text/css" href="../css/layout-default.css" />
<link rel="stylesheet" type="text/css" href="../css/main.css" />
<link rel="stylesheet" type="text/css" href="../css/study-files.css" />
<link rel="stylesheet" type="text/css" href="../css/uploadfile.css" />
<link rel="stylesheet" type="text/css"
	href="../css/jquery.dataTables2.css">


<script type="text/javascript" src="../js/jquery-1.10.2.js"></script>
<script type="text/javascript" src="../js/jquery-ui-1.10.4.js"></script>
<script type="text/javascript" src="../js/jquery.layout-1.3.0.js"></script>
<script type="text/javascript" src="../js/jquery.validate.js"></script>
<script type="text/javascript" src="../js/jquery.blockUI.js"></script>
<script type="text/javascript" src="../js/purl.js"></script>
<script type="text/javascript" src="../js/jquery.form.js"></script>
<script type="text/javascript" src="../js/jquery.uploadfile.js"></script>
<script type="text/javascript" src="../js/jquery.dataTables.js"></script>
<script type="text/javascript" src="../js/ddweb.js"></script>

<script type="text/javascript">
			var mainLayout = null;
			var studyID = null;
			var study = null;
			var userinfo = null;
			var editMode = false;
			
			$(document).ready(function() {
				studyID = $.url().param('s');
				editMode = $.url().param('e') == '1';
				document.title += ' - Estudio: ' + studyID;

				$.getJSON("rest/user/info")
				  .done(function(info) {
					  	userinfo = info;
					  	
						$.getJSON("rest/studies/" + studyID)
						  .done(function(studyinfo) {
							  study = studyinfo;
							  initPage();
						  })
						  .fail(function() {
								if (window.parent.closeModalDialog)
									window.parent.closeModalDialog();					
						    	return;
						  });					  	
				  })
				  .fail(function() {
						if (window.parent.closeModalDialog)
							window.parent.closeModalDialog();					
				    	return;
				  });
				
				$( '.study-files-layout-south' ).hide();
				$( '.study-files-layout-center' ).hide();
			});

			function initPage() {
				if (!actionIsAllowed(userinfo, study.iid, 'view-study-files')) {
					if (window.parent.closeModalDialog)
						window.parent.closeModalDialog();					
			    	return;					
				}
				
				if (!editMode) {
					mainLayout = $('body').layout({
						center__paneSelector:	".study-files-layout-north",
											
						center__closable : false,
						center__resizable : false,
						center__spacing_open : 0,
						center__spacing_closed : 0,
						center__minSize: 350
					});					
				}
				else {
					if (actionIsAllowed(userinfo, study.iid, 'upload-study-file')) {
						$("#fileuploader").uploadFile({
							url: 'rest/studies/' + studyID + '/files',
							fileName: "study-file",
							autoSubmit: true,
							showDone: false,
							maxFileSize: 52428800,
				            dragDropStr: "<span><b>Arrastre archivos aqu&iacute;</b></span>",
				            abortStr: "Abortar",
				            cancelStr: "Cancelar",
				            deletelStr: "Eliminar",
				            doneStr: "Finalizado",
				            multiDragErrorStr: "No se permite arrastrar y soltar m&uacute;ltiples archivos. Realice la acci&oacute;n de a un archivo a la vez.",
				            extErrorStr: "no est&aacute; permitido este tipo de archivo. Extensiones de archivo permitidas: ",
				            sizeErrorStr: " super&oacute; el tama&ntilde;o m&aacute;ximo de archivo. Tama&ntilde;o m&aacute;ximo permitido: ",
				            uploadErrorStr: "No permitido",
				            showStatusAfterSuccess: false,
				            showStatusAfterError: false,		            
							afterUploadAll:function()
							{
								populateFiles();
	  						    if (window.parent && window.parent.updateStudyData)
								  window.parent.updateStudyData(studyID);						  							
							},
							onError: function(files,status,errMsg)
							{
								alert('Ha ocurrido un error cargando los nuevos archivos. Por favor, reintente la operación.');
								populateFiles();
	  						    if (window.parent && window.parent.updateStudyData)
	  							  window.parent.updateStudyData(studyID);						  
							}					
						});
					} else {
						$('#fileuploader').remove();
					}
					
					mainLayout = $('body').layout({
						north__paneSelector:	".study-files-layout-north",
						center__paneSelector:	".study-files-layout-center",
						south__paneSelector:	".study-files-layout-south",
											
						north__closable : false,
						north__resizable : false,
						north__spacing_open : 0,
						north__spacing_closed : 0,
						north__minSize: 350
	
						,
						center__closable : false,
						center__resizable : false,
						center__spacing_open : 0,
						center__spacing_closed : 0,
						center__maxSize: 200
						
						,
						south__closable : false,
						south__resizable : false,
						south__spacing_open : 0,
						south__spacing_closed : 0,
						south__maxSize: 40					
					});
									
					$('#study-files-refresh').button
					({
					    icons: { primary: "ui-icon-refresh" }, text: true
					});
					$('#study-files-exit').button
					({
					    icons: { primary: "ui-icon-close" }, text: true
					});
					
					$('#study-files-refresh').click(function() {
						populateFiles();
					});				
					$('#study-files-exit').click(function() {
						//if (window.parent.closeModalDialog)
						//	window.parent.closeModalDialog();
						$("#dynamicModalDialog").dialog("close");
					});		
				}

				// Tabla de archivos relacionados al estudio.
				var columns = [
          						{ "title": "ARCHIVO", "data": "name", "defaultContent": "-", "class": "left" }
          					  ];
				var columnDefs = [
            				       {  "targets": 0,
         				              "render": function ( data, type, row ) {
         				            	  //if (actionIsAllowed(userinfo, study.iid, 'download-study-file')) { 
       				            		  //   var url = 'rest/studies/'  + studyID + '/files/file?name=' + row.name;
       				                      //   return "<a target='_blank' href='" + url + "'><span>" + row.name + "</span></a>";
         				            	  //} else 
         				            		  return "<span>" + row.name + "</span>";
       				                   }					                   
         				           }					               
         						 ];				

				if (editMode && actionIsAllowed(userinfo, study.iid, 'delete-study-file')) {
					columns.push({ "title": "ELIMINAR", "data": null, "class": "left", "width": "40px" });															
		            columnDefs.push({
		            	   "targets": 1,
		            	   "render": function ( data, type, row ) {
		            		   var url = 'rest/studies/'  + studyID + '/files/file?name=' + row.name;
		            		   return "<a href=\"#\"' onclick=\"deleteFile('" + row.name + "', '" + url + "');\"><span>Eliminar</span></a>";
		                   }			                   
		            });
				}
				
				$('#study-files-table').dataTable({
					"data": [],
					"lengthMenu": [ 5, 10, 15, 20, 25, 30, 50, 75, 100 ],
					"lengthChange": false,
					"pageLength": 10,
					"columns": columns,					
					"columnDefs": columnDefs,					
					"language": {
			            "lengthMenu": "Mostrar _MENU_ archivos por página",
			            "zeroRecords": "No se encontraron archivos para mostrar con los criterios especificados.",
			            "info": "Mostrando página _PAGE_ de _PAGES_",
			            "infoEmpty": "Sin archivos para mostrar",
			            "infoFiltered": "(filtrados de un total de _MAX_ archivos)",
					    "emptyTable":     "Sin archivos para mostrar",
					    "infoPostFix":    "",
					    "thousands":      ".",
					    "loadingRecords": "Cargando...",
					    "processing":     "Procesando...",
					    "search":         "Buscar:",
					    "paginate": {
					        "first":      "Primera",
					        "last":       "Última",
					        "next":       "Siguiente",
					        "previous":   "Anterior"
					    },
					    "aria": {
					        "sortAscending":  ": Click para ordenar ascendentemente",
					        "sortDescending": ": Click para ordenar descendentemente"
					    }
					}				
				});
								
				populateFiles();				
			}
			
			function populateFiles() {
				if (!actionIsAllowed(userinfo, study.iid, 'view-study-files'))
					return;
				
				$.get('rest/studies/' + studyID + '/files')
				  .done(function(result) {
					  	var dt = $('#study-files-table').dataTable();
					  	dt.fnClearTable();
					  	if (result && result.length > 0) {
					  		var data = [];
					  		$.each(result, function(index, item) {
					  			data[index] = {
					  				name: item
					  			};
					  		});
					  		dt.fnAddData(data);
					  	}
				  })
				  .fail(function() {
				    alert('Ocurrió un error en la comunicación con el servidor. ' + 
				    	'Por favor, reintente la operación realizada.');
					if (window.parent.closeModalDialog)
						window.parent.closeModalDialog();
				  });
			}
			
			function deleteFile(filename, url) {
				if (confirm('¿Confirma la eliminación del archivo "' + filename + '"?')) {
					$.ajax({
					    url: url,
					    type: 'DELETE'
					}).done(function() {
						populateFiles();
					    if (window.parent && window.parent.updateStudyData)
						  window.parent.updateStudyData(studyID);						  
						
					})					
					.fail(function() {
					    alert('Ocurrió un error en la comunicación con el servidor. ' + 
					    	'Por favor, reintente la operación realizada.');
					    populateFiles();
						if (window.parent && window.parent.updateStudyData)
						  window.parent.updateStudyData(studyID);											    
					});
				}
			}
		</script>
</head>
<body>
	<div class="study-files-layout-north">
		<table id="study-files-table" class="display"></table>
	</div>
	<div class="study-files-layout-center">
		<div id="fileuploader" class="single-file-uploader">Subir
			archivo</div>
	</div>
	<!--<div class="study-files-layout-south">
			<button type="button" id="study-files-refresh" class="study-action-button">Actualizar</button>
			<button type="button" id="study-files-exit" class="study-action-button">Salir</button>
		</div>-->
</body>
</html>
